# DOIO KB16 キーマッピング改善ガイド

このガイドでは、DOIO KB16キーボードの正確なキーマッピングを確立するための手順を説明します。

## 問題点

現在のキーマッピングでは以下の問題が発生しています：
- 一部のキーが実際のキーと異なるキーコードを出力する
- 一部のキーが反応しない

## 解決方法

2つのツールを用意しました：

1. **キャリブレーションツール (`kb16_mapping_calibrator.py`)**:
   - 各キーを順番に押して、データパケットの変化を直接分析
   - 最も正確なビットマッピングを自動的に生成

2. **マッピング調整ツール (`kb16_mapping_adjuster.py`)**:
   - 既存のマッピングを視覚的に表示
   - 特定のキーのマッピング情報を手動で調整
   - 更新されたC++コードを生成

## 準備

以下のライブラリが必要です：

```bash
pip install pyusb
```

## キャリブレーションツールの使用方法

このツールでは、各キーを順番に押して応答を記録します：

1. KB16キーボードをUSBで接続
2. 以下のコマンドを実行：

```bash
cd /Users/kotaniryota/Documents/PlatformIO/Projects/DOIO_Bluetooth/python
./kb16_mapping_calibrator.py
```

3. 画面の指示に従って各キーを押す
4. 結果のマッピングコードが生成される

**注意**: このツールの実行にはroot/管理者権限が必要な場合があります。

## マッピング調整ツールの使用方法

すでにある程度のデータがあり、微調整したい場合に便利です：

```bash
cd /Users/kotaniryota/Documents/PlatformIO/Projects/DOIO_Bluetooth/python
./kb16_mapping_adjuster.py
```

対話型インターフェースで以下の操作ができます：
1. 現在のマッピングを表示
2. 特定のキーのマッピング情報を調整
3. 更新されたC++コードを生成
4. マッピングをJSONファイルとして保存

## マッピング更新手順

1. キャリブレーションまたは調整ツールを実行
2. 生成されたコードをEspUsbHost.cpp内の該当部分に貼り付け：
   - `kb16_key_map[]` 配列を更新
   - 必要に応じて `onKeyboard` 関数内のキー判定部分も更新
3. コードを再度コンパイルしてアップロード
4. キー入力をテスト

## トラブルシューティング

- **キーが反応しない場合**: 該当するキーのバイトインデックスとビットマスクの組み合わせが正確か確認
- **誤ったキーコードが出力される場合**: `onKeyboard` 関数内のHIDキーコード変換部分を確認
- **USB接続の問題**: デバイスのアクセス権限を確認（Linux/Macでは通常root権限が必要）

## 応用

収集したデータを分析して、より高度なカスタマイズも可能です：
- キーのリマッピング（複数のHIDキーコードの組み合わせなど）
- マクロ機能の実装
- カスタムLED制御のタイミング調整

## 参考資料

- [USBデバイス分析方法](https://www.usb.org/documents)
- [HIDキーコード一覧](https://usb.org/sites/default/files/hut1_22.pdf)
