# DOIO KB16 キーボード解析ガイド

このガイドでは、DOIO KB16キーボードの内部データ構造とHIDレポート形式を解析するための手順を説明します。

## 概要

DOIO KB16キーボードは以下の特徴を持っています：

- ベンダーID: 0xD010
- プロダクトID: 0x1601
- 4×4のキーマトリックス（16キー）
- 3つの特殊キー（e0, e1, e2）
- USB HID (Human Interface Device) プロトコルを使用

## 用意したツール

1. **kb16_raw_input.py** - 最も基本的なツールで、複数のインターフェースに接続を試み、生のHIDデータを取得します
2. **kb16_protocol_analyzer.py** - キーボードからのHIDレポートを捕捉し、キーイベントを詳細に解析します
3. **kb16_analyzer_utils.py** - 収集したデータを解析し、キーマトリックス構造を推測します
4. **kb16_advanced_analyzer.py** - 最も高度なツールで、ビットマップ解析や統計情報を提供します
5. **analyze_kb16.sh** - 全ての解析プロセスを自動化するシェルスクリプト

## 問題の診断

キーボードの接続時に以下のような問題が発生する場合があります：

- デバイスが検出されない
- インターフェースが正しく選択されない
- レポート形式が標準と異なる
- キーマトリックスのマッピングが未知

## 使用方法

### 基本的な接続テスト

```bash
# 直接接続テスト
python3 kb16_raw_input.py

# 全インターフェースを試す場合
python3 kb16_raw_input.py --all-interfaces
```

### プロトコル解析

```bash
# デフォルト設定（60秒間キャプチャ）
python3 kb16_protocol_analyzer.py

# キャプチャ時間を変更（30秒）
python3 kb16_protocol_analyzer.py --duration 30
```

### キャプチャデータの解析

```bash
# JSONキャプチャファイルを解析
python3 kb16_analyzer_utils.py kb16_capture_XXXXXXXX.json
```

### 自動解析（推奨）

```bash
# 全プロセスを自動化
./analyze_kb16.sh
```

## 解析結果の見方

1. **ビットマップ解析**：どのバイト/ビットがキーボタンに対応しているか
2. **マトリックス構造**：物理的なキー配置との対応関係
3. **EspUsbHost.cpp用コード**：ESP32で実装するためのコード例
4. **統計情報**：レポートパターン、頻度、キー使用統計

## ESP32での実装

解析結果に基づいて、`EspUsbHost.cpp`を以下のように修正します：

1. キーマッピング構造体と配列を追加
2. DOIO KB16用の条件分岐を追加（VID/PIDで識別）
3. レポートのバイト・ビットレベルでのデータ解析処理を実装

## トラブルシューティング

- **レポートが取得できない場合**：別のインターフェース番号を試す
- **キーマトリックスが認識されない場合**：より多くのキーサンプルを取得する
- **macOSでの接続問題**：`--all-interfaces`オプションを使用する

## ファイル形式

- **JSON**：詳細な解析データ（タイムスタンプ、バイナリデータ、分析結果）
- **CSV**：表形式データ（Excel等で閲覧可能）
- **TXT**：テキスト形式の解析結果サマリー
